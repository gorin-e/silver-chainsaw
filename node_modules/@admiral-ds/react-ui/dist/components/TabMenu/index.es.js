import{jsxs,jsx}from"react/jsx-runtime";import{useState,useEffect,useMemo,createRef,useRef,createElement,useLayoutEffect}from"react";import{keyboardKey}from"../common/keyboardKey.es.js";import{Badge}from"../Badge/index.es.js";import{MenuItem}from"../Menu/MenuItem.es.js";import{MenuItemWrapper,IconWrapper,BadgeWrapper,Wrapper,Underline,TabWrapper,Tab,TabContentWrapper,TabContent,OverflowMenuContainer,StyledOverflowMenu}from"./style.es.js";import{debounce}from"../common/utils/debounce.es.js";const TabMenu=({tabs,dimension="l",underline=!1,mobile=!1,alignSelf="flex-end",activeTab,onChange,dropContainerCssMixin,dropContainerClassName,dropContainerStyle,...props})=>{const[openedMenu,setOpenedMenu]=useState(!1),[visibilityMap,setVisibilityMap]=useState({});useEffect(()=>{const visibility=tabs.reduce((initialMap,_,index)=>(initialMap[index]=!0,initialMap),{});setVisibilityMap(visibility)},[tabs]);const tabsWithRef=useMemo(()=>tabs.map(tab=>({...tab,ref:createRef()})),[tabs]),overflowMenuRefs=useMemo(()=>tabs.slice(0,tabs.length-1).map((_,index)=>({ref:createRef(),isVisible:visibilityMap[index]&&!visibilityMap[index+1]})),[tabs,visibilityMap]),currentOverflowMenuRef=useMemo(()=>{const visibleMenu=overflowMenuRefs.find(item=>item.isVisible);return visibleMenu?visibleMenu.ref:null},[overflowMenuRefs,visibilityMap]),visibleRefsMap=useMemo(()=>{let refsMap=[];return mobile?refsMap=tabsWithRef.map(item=>item.ref):(tabsWithRef.forEach((item,index)=>{visibilityMap[index]&&refsMap.push(item.ref)}),null!==currentOverflowMenuRef&&refsMap.push(currentOverflowMenuRef)),refsMap},[visibilityMap,tabsWithRef,currentOverflowMenuRef,overflowMenuRefs,mobile]),tablistRef=useRef(null),underlineRef=useRef(null),activeTabIsVisible=useMemo(()=>{const activeTabIndex=tabsWithRef.findIndex(item=>item.id===activeTab);return visibilityMap[activeTabIndex]},[tabsWithRef,activeTab,visibilityMap]),modelAllTabs=useMemo(()=>tabsWithRef.map(item=>({id:item.id,render:options=>createElement(MenuItem,{dimension,...options,key:item.id},jsxs(MenuItemWrapper,{children:[item.icon&&jsx(IconWrapper,{$dimension:dimension,children:item.icon}),item.content,void 0!==item.badge&&jsx(BadgeWrapper,{children:jsx(Badge,{"data-badge":!0,dimension:"s",appearance:item.id===activeTab?"info":item.disabled?"lightDisable":"lightInactive",children:item.badge})})]})),disabled:item.disabled})),[dimension,tabs,tabsWithRef,activeTab]),containsActiveTab=items=>-1!=items.findIndex(item=>item.id===activeTab),getNextElement=target=>{let currentIndex=visibleRefsMap.findIndex(item=>target===item.current);return currentIndex<visibleRefsMap.length-1?currentIndex++:currentIndex=0,visibleRefsMap[currentIndex].current},getPreviousElement=target=>{let currentIndex=visibleRefsMap.findIndex(item=>target===item.current);return 0===currentIndex?currentIndex=visibleRefsMap.length-1:currentIndex--,visibleRefsMap[currentIndex].current},styleUnderline=(left,width)=>{underlineRef.current&&(underlineRef.current.style.left=left+"px",underlineRef.current.style.width=width+"px",underlineRef.current.style.display=width?"flex":"none")};useLayoutEffect(()=>{if(tablistRef.current?.firstElementChild){const resizeObserver=new ResizeObserver(debounce(function(){const activeTabRef=tabsWithRef.filter(tab=>tab.id===activeTab)?.[0]?.ref.current,left=parseFloat(underlineRef.current?.style.left||"0"),underlineWidth=parseFloat(underlineRef.current?.style.width||"0");if(activeTabRef&&tablistRef.current){const activeTabWidth=activeTabRef.getBoundingClientRect().width,activeTabLeft=activeTabRef.getBoundingClientRect().left-tablistRef.current.getBoundingClientRect().left+tablistRef.current.scrollLeft;activeTabLeft===left&&activeTabWidth===underlineWidth||styleUnderline(activeTabLeft,activeTabWidth)}activeTabRef&&(mobile||activeTabIsVisible)||styleUnderline(0,0)},100));return resizeObserver.observe(tablistRef.current?.firstElementChild),()=>{resizeObserver.disconnect()}}},[tabsWithRef,activeTab,dimension,visibilityMap]),useLayoutEffect(()=>{const observer=new IntersectionObserver(entries=>{const updatedEntries={};entries.forEach(entry=>{const targetNumber=entry.target.dataset.number;void 0!==targetNumber&&(updatedEntries[targetNumber]=entry.isIntersecting&&entry.intersectionRatio>.99)}),setVisibilityMap(prev=>({...prev,...updatedEntries}))},{root:tablistRef.current,threshold:[0,1]});return tablistRef.current&&!mobile&&Array.from(tablistRef.current.children).forEach(item=>{observer.observe(item)}),()=>observer.disconnect()},[tabsWithRef,mobile,visibilityMap]);const handleTabClick=event=>{mobile&&event.currentTarget.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"}),onChange(event.currentTarget.id),event.currentTarget.blur()},handleTabKeyUp=event=>{const code=keyboardKey.getCode(event);code!==keyboardKey.Enter&&code!==keyboardKey[" "]||onChange(event.currentTarget.id)},getTabIndex=id=>tabsWithRef.findIndex(item=>item.id===id),renderOverflowMenu=id=>{const tabNumber=getTabIndex(id),tabsForMenu=modelAllTabs.slice(tabNumber+1),overflowMenuHidden=tabNumber===tabsWithRef.length-1||!(visibilityMap[tabNumber]&&!visibilityMap[tabNumber+1]),tabIndex=overflowMenuHidden||!tabsForMenu?.filter(item=>item.id===activeTab).length?-1:0,overflowRef=overflowMenuRefs[tabNumber]?overflowMenuRefs[tabNumber].ref:null;return jsx(OverflowMenuContainer,{$dimension:dimension,$isHidden:overflowMenuHidden,children:jsx(StyledOverflowMenu,{ref:overflowRef,onOpen:()=>setOpenedMenu(!0),onClose:()=>setOpenedMenu(!1),alignSelf,items:overflowMenuHidden?[]:tabsForMenu,selected:containsActiveTab(tabsForMenu)?activeTab:void 0,dimension,$isActive:containsActiveTab(tabsForMenu),disabled:tabsForMenu.every(tab=>tab.disabled),onChange:id=>{onChange(id),styleUnderline(0,0)},tabIndex,dropContainerCssMixin,dropContainerClassName,dropContainerStyle})})},renderTab=item=>{const{disabled,content,id,icon,badge,ref,...props}=item;return jsx(Tab,{ref,id,role:"tab",type:"button","aria-selected":id===activeTab,$selected:id===activeTab,tabIndex:id===activeTab?0:-1,$dimension:dimension,disabled,onClick:handleTabClick,onKeyUp:handleTabKeyUp,...props,children:jsxs(TabContentWrapper,{$dimension:dimension,tabIndex:-1,children:[icon&&icon,jsx(TabContent,{children:content}),void 0!==badge&&jsx(Badge,{"data-badge":!0,dimension:"s",appearance:id===activeTab?"info":disabled?"lightDisable":"lightInactive",children:badge})]})},id)};return jsxs(Wrapper,{role:"tablist",ref:tablistRef,$underline:underline,$mobile:mobile,$dimension:dimension,onKeyDown:event=>{const{target}=event;let newFocusTarget;switch(keyboardKey.getCode(event)){case keyboardKey.Tab:activeTabIsVisible||(newFocusTarget=currentOverflowMenuRef,event.preventDefault());break;case keyboardKey.ArrowLeft:newFocusTarget=(target=>{let previousElement=getPreviousElement(target);for(;previousElement?.disabled;)previousElement=getPreviousElement(previousElement);return previousElement})(target),event.preventDefault();break;case keyboardKey.ArrowRight:newFocusTarget=(target=>{let nextElement=getNextElement(target);for(;nextElement?.disabled;)nextElement=getNextElement(nextElement);return nextElement})(target),event.preventDefault()}!openedMenu&&newFocusTarget&&newFocusTarget.focus()},...props,children:[tabsWithRef.map((item,index)=>{const{id}=item,tabNumber=getTabIndex(id),needsOffset=!mobile&&0!==tabNumber&&visibilityMap[tabNumber-1];return jsxs(TabWrapper,{"data-number":index,$needsOffset:needsOffset,$dimension:dimension,children:[renderTab(item),mobile||tabNumber===tabsWithRef.length-1?null:renderOverflowMenu(id)]},id)}),jsx(Underline,{ref:underlineRef,"aria-hidden":!0})]})};TabMenu.displayName="TabMenu";export{TabMenu};
//# sourceMappingURL=index.es.js.map
