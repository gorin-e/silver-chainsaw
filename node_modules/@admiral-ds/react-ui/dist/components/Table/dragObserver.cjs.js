"use strict";var throttle=require("../common/utils/throttle.cjs.js");const crossvent={add:function(el,type,fn,capturing){return el.addEventListener(type,fn,capturing)},remove:function(el,type,fn,capturing){return el.removeEventListener(type,fn,capturing)}};function touchy(el,op,type,fn){crossvent[op](el,{mouseup:"touchend",mousedown:"touchstart",mousemove:"touchmove"}[type],fn),crossvent[op](el,type,fn)}function getElementBehindPoint(point,x,y){const state=point.style.pointerEvents;point.style.pointerEvents="none";const el=document.elementFromPoint(x,y);return point.style.pointerEvents=state,el}function always(){return!0}function invalidTarget(){return!1}function getParent(el){return el.parentNode===document?null:el.parentNode}function getCoord(coord,e){const host=function(e){return e.targetTouches&&e.targetTouches.length?e.targetTouches[0]:e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:e}(e);return host[coord]}exports.dragObserver=function(initialContainers,options,onDrop,onDragStart,onDragEnd){let _mirror,_source,_item,_initialSibling,_currentSibling,_grabbed,_mirrorContainerStyle,_itemId="",_lastDropTarget=null,_currentTarget=null;const o={...options,direction:options.direction??"horizontal",updateDragItem:options.updateDragItem,accepts:options.accepts??always,invalid:options.invalid??invalidTarget,containers:[...initialContainers]},drake={containers:o.containers,unobserve:function(){events(!0),release({}),freeResources()},dragging:!1},[drag,freeResources]=throttle.throttle(handleDrag,10);return events(),drake;function isContainer(el){return-1!==drake.containers.indexOf(el)}function events(remove){const op=remove?"remove":"add";touchy(document.documentElement,op,"mousedown",grab),touchy(document.documentElement,op,"mouseup",release)}function eventualMovements(remove){const op=remove?"remove":"add";touchy(document.documentElement,op,"mousemove",startBecauseMouseMoved)}function movements(remove){crossvent[remove?"remove":"add"](document.documentElement,"click",preventGrabbed)}function preventGrabbed(e){_grabbed&&e.preventDefault()}function grab(e){const context=function(item){if(drake.dragging&&_mirror)return;if(isContainer(item))return;const handle=item;for(;getParent(item)&&!1===isContainer(getParent(item));){if(o.invalid(item,handle))return;if(!(item=getParent(item)))return}const source=getParent(item);if(!source)return;if(o.invalid(item,handle))return;return{item,source}}(e.target);context&&(_grabbed=context,eventualMovements(),"mousedown"===e.type&&e.preventDefault())}function startBecauseMouseMoved(e){if(!_grabbed)return;if(0==e.movementX&&0==e.movementY)return;const grabbed=_grabbed;var context;eventualMovements(!0),movements(),function(){if(!drake.dragging)return;cleanup()}(),_source=(context=grabbed).source,_item=context.item,_itemId="vertical"==o.direction?context.item?.dataset?.row:context.item?.dataset?.thColumn,_currentTarget=context.item,_initialSibling=_currentSibling=context.item.nextElementSibling,drake.dragging=!0,onDragStart?.(),_item&&(_item.dataset.dragover="true",function(){const mirrorElement=o.mirrorRef.current;if(_mirror&&!mirrorElement)return;if(mirrorElement){o.renderMirror(_item),mirrorElement.style.visibility="visible",_mirror=mirrorElement,touchy(document.documentElement,"add","mousemove",drag);const mirrorParent=mirrorElement.parentElement;mirrorParent&&(_mirrorContainerStyle=mirrorParent.style.userSelect,mirrorParent.style.userSelect="none")}}(),handleDrag(e))}function ungrab(){_grabbed=!1,eventualMovements(!0),movements(!0)}function release(e){if(ungrab(),!drake.dragging)return;const clientX=getCoord("clientX",e)||0,clientY=getCoord("clientY",e)||0,dropTarget=findDropTarget(getElementBehindPoint(_mirror,clientX,clientY),clientX,clientY);dropTarget&&dropTarget!==_source?cleanup():function(){if(!drake.dragging)return;cleanup()}()}function cleanup(){ungrab(),function(){const mirrorElement=o.mirrorRef.current;if(_mirror&&mirrorElement){const mirrorParent=mirrorElement.parentElement;mirrorParent&&(mirrorParent.style.userSelect=_mirrorContainerStyle),o.removeMirror(),mirrorElement.style.visibility="hidden",touchy(document.documentElement,"remove","mousemove",drag),_mirror=null}}(),delete _item?.dataset?.dragover,delete _currentTarget?.dataset?.groupover,drake.dragging=!1,onDragEnd?.(_item),_source=_item=_initialSibling=_currentSibling=_lastDropTarget=_currentTarget=null,_itemId=""}function findDropTarget(elementBehindCursor,clientX,clientY){let target=elementBehindCursor;for(;target&&!accepted();)target=getParent(target);return target;function accepted(){if(!1===isContainer(target))return!1;const immediate=getImmediateChild(target,elementBehindCursor),reference=getReference(target,immediate,clientX,clientY),initial=function(target,s){let sibling;return sibling=void 0!==s?s:_mirror?_currentSibling:getItemNextSibling(),target===_source&&sibling===_initialSibling}(target,reference);return!!initial||o.accepts(_item,target,_source,reference)}}function handleDrag(e){if(!_mirror)return;if(e.preventDefault(),o.updateDragItem){const updatedItem=o.updateDragItem?.(_itemId);updatedItem&&(delete _item?.dataset?.dragover,updatedItem.dataset.dragover="true",_item=updatedItem)}const clientX=getCoord("clientX",e)||0,clientY=getCoord("clientY",e)||0;let x,y;"vertical"===o.direction?(x=clientX-("s"===o.dimension||"m"===o.dimension?18:24),y=clientY-_mirror.getBoundingClientRect().height/2):"horizontal"===o.direction&&(x=clientX-("s"===o.dimension||"m"===o.dimension?18:20),y=clientY-_mirror.getBoundingClientRect().height/2),_mirror.style.left=x+"px",_mirror.style.top=y+"px";const elementBehindCursor=getElementBehindPoint(_mirror,clientX,clientY),dropTarget=findDropTarget(elementBehindCursor,clientX,clientY),changed=null!==dropTarget&&dropTarget!==_lastDropTarget;let reference;(changed||null===dropTarget)&&(_lastDropTarget=dropTarget),_mirror.dataset.cursor=null==dropTarget?"error":"normal";const immediate=getImmediateChild(dropTarget,elementBehindCursor);if(_currentTarget?.isEqualNode(immediate)||null==immediate)updateCurrentTarget(immediate);else if(updateCurrentTarget(immediate),reference=getReference(dropTarget,immediate,clientX,clientY),_item&&(null===reference&&changed||reference!==_item&&reference!==getItemNextSibling())){if(_currentSibling=reference,null===getItemNextSibling()&&null===reference)return;onDrop?.(_item,reference,immediate)}}function updateCurrentTarget(immediate){"vertical"===o.direction&&(delete _currentTarget?.dataset.groupover,"true"==immediate?.dataset?.group&&(immediate.dataset.groupover="true")),_currentTarget=immediate}function getItemNextSibling(){const updatedItem=o.updateDragItem?.(_itemId,!0)||_item;return updatedItem?.nextElementSibling}function getItemRect(){const updatedItem=o.updateDragItem?.(_itemId,!0)||_item;return updatedItem?updatedItem.getBoundingClientRect():{}}function getImmediateChild(dropTarget,target){let immediate=target;for(;immediate!==dropTarget&&getParent(immediate)!==dropTarget;)immediate=getParent(immediate);return immediate===document.documentElement?null:immediate}function getReference(dropTarget,target,x,y){const horizontal="horizontal"===o.direction,itemRight=getItemRect()?.right,itemBottom=getItemRect()?.bottom;return target!==dropTarget?function(){const rect=target.getBoundingClientRect();if(horizontal&&"number"==typeof itemRight)return resolve(x>=rect.left&&x<rect.right&&itemRight<=x);if(!horizontal&&"number"==typeof itemBottom)return resolve(y>=rect.top&&y<rect.bottom&&itemBottom<=y);return null}():function(){const len=dropTarget.children.length;for(let i=0;i<len;i++){const el=dropTarget.children[i],rect=el.getBoundingClientRect();if(horizontal&&"number"==typeof itemRight&&x>=rect.left&&x<rect.right)return itemRight<=x?el.nextElementSibling:el;if(!horizontal&&"number"==typeof itemBottom&&y>=rect.top&&y<rect.bottom)return itemBottom<=y?el.nextElementSibling:el}return null}();function resolve(after){return after?target.nextElementSibling:target}}};
//# sourceMappingURL=dragObserver.cjs.js.map
