import{jsxs,jsx,Fragment}from"react/jsx-runtime";import*as e from"react";import"../form/InputField/index.es.js";import{CheckboxField}from"../form/CheckboxField/index.es.js";import"../form/DateField/index.es.js";import"../form/SelectField/index.es.js";import"../form/FieldSet/index.es.js";import"../form/SuggestField/index.es.js";import"../form/TextField/index.es.js";import"../form/SliderInputField/index.es.js";import"../form/SliderRangeField/index.es.js";import"../form/TimeField/index.es.js";import"../form/NumberInputField/index.es.js";import"../form/EditModeField/index.es.js";import"../form/EditModeAreaField/index.es.js";import"../form/PhoneInputField/index.es.js";import"../form/InputExField/index.es.js";import"../form/FileInputField/index.es.js";import"../form/MultiInputField/index.es.js";import"../form/TreeSelectField/index.es.js";import{useTheme}from"styled-components";import{LIGHT_THEME}from"../themes/light/index.es.js";import"../themes/common/locales.es.js";import"../Typography/typography.es.js";import"../Typography/defaultTypographyMixin.es.js";import{GroupRow}from"./Row/GroupRow.es.js";import{RegularRow}from"./Row/RegularRow.es.js";import{RowWrapper}from"./Row/RowWrapper.es.js";import{refSetter}from"../common/utils/refSetter.es.js";import{debounce}from"../common/utils/debounce.es.js";import{HeaderCellComponent}from"./HeaderCell.es.js";import{ColumnDrag}from"./drag/ColumnDrag.es.js";import{RowDrag}from"./drag/RowDrag.es.js";import{TableContainer,HeaderWrapper,Header,Edge,StickyWrapper,DragCell,ExpandCell,CheckboxCell,NormalWrapper,Filler,ActionMock,HiddenHeader,HeaderCellsWrapper,Body,Row,EmptyMessage,Cell,CellTextContent}from"./style.es.js";import{FixedSizeBody}from"./virtualScroll/FixedSizeBody.es.js";import{DynamicSizeBody}from"./virtualScroll/DynamicSizeBody.es.js";export{RowAction}from"./RowAction.es.js";const DEFAULT_COLUMN_WIDTH=100,TABLE_ROW_STATUS_MAP={error:color=>color["Error/Error 20"],success:color=>color["Success/Success 20"]},Table=e.forwardRef(({columnList,rowList,displayRowSelectionColumn=!1,displayRowExpansionColumn=!1,headerCheckboxChecked=!1,headerCheckboxIndeterminate=!1,headerCheckboxDisabled=!1,onHeaderSelectionChange,onRowSelectionChange,onRowExpansionChange,onRowClick,onRowDoubleClick,onSortChange,onColumnResize,renderCell,renderRowWrapper,dimension="m",greyHeader=!1,greyZebraRows=!1,spacingBetweenItems,headerLineClamp=1,headerExtraLineClamp=1,showDividerForLastColumn=!1,disableColumnResize=!1,showLastRowUnderline=!0,showRowsActions:userShowRowsActions=!1,virtualScroll,locale,onColumnDrag,onColumnDragEnd,rowsDraggable=!1,onRowDrag,onRowDragEnd,draggedColumnCssMixin,draggedRowCssMixin,rowBackgroundColorByStatusMap:userRowBackgroundColorByStatusMap,showBorders=!1,...props},ref)=>{const theme=useTheme()||LIGHT_THEME,checkboxDimension="s"===dimension||"m"===dimension?"s":"m",columnMinWidth="s"===dimension||"m"===dimension?25:33,[tableHeight,setTableHeight]=e.useState(0),[headerHeight,setHeaderHeight]=e.useState(0),stickyColumns=[...columnList].filter(col=>col.sticky),isAnyColumnDraggable=columnList.filter(col=>!col.sticky&&col.draggable).length>0,isAnyStickyColumnDraggable=columnList.filter(col=>col.sticky&&col.draggable).length>0,showRowsActions=e.useMemo(()=>rowList.some(row=>row.actionRender||row.overflowMenuRender)&&userShowRowsActions,[rowList,userShowRowsActions]),rowStatusMap=e.useMemo(()=>({...TABLE_ROW_STATUS_MAP,...userRowBackgroundColorByStatusMap}),[userRowBackgroundColorByStatusMap]),tableRef=e.useRef(null),headerRef=e.useRef(null),hiddenHeaderRef=e.useRef(null),bodyRef=e.useRef(null),stickyColumnsWrapperRef=e.useRef(null),normalColumnsWrapperRef=e.useRef(null),fillerRef=e.useRef(null),leftEdgeRef=e.useRef(null),rightEdgeRef=e.useRef(null),groupToRowsMap=rowList.reduce((acc,row)=>(void 0!==row.groupRows&&(acc[row.id]={rows:[...row.groupRows],expanded:!!row.expanded}),acc),{}),rowToGroupMap=Object.entries(groupToRowsMap).reduce((acc,[groupId,info])=>(info.rows.forEach(id=>{const row=rowList.find(item=>item.id.toString()===id);row&&!groupToRowsMap[id]&&(acc[id]={groupId,checked:!!row.selected})}),acc),{}),tableRows=e.useMemo(()=>(()=>{const tableRows=[];return rowList.forEach(row=>{const isGroupRow=!!groupToRowsMap[row.id];!!rowToGroupMap[row.id]||tableRows.push(row),isGroupRow&&groupToRowsMap[row.id].rows.forEach(rowId=>{const row=rowList.find(item=>item.id.toString()===rowId);row&&tableRows.push(row)})}),tableRows})(),[rowList]),zebraRows=greyZebraRows?tableRows.reduce((acc,row,index)=>{if(rowToGroupMap[row.id]){const indexInGroup=groupToRowsMap[rowToGroupMap[row.id]?.groupId]?.rows.indexOf(String(row.id));acc[row.id]="ingroup "+(indexInGroup%2==0?"odd":"even")}else groupToRowsMap[row.id]?acc[row.id]="group":0===index||acc[tableRows[index-1]?.id].includes("group")?acc[row.id]="odd":acc[row.id]="odd"===acc[tableRows[index-1]?.id]?"even":"odd";return acc},{}):{},updateColumnsWidth=()=>{const hiddenColumns=hiddenHeaderRef.current?.querySelectorAll(".th");hiddenColumns&&(Array.from(hiddenColumns).map(column=>({index:column.dataset.index,width:column.getBoundingClientRect().width})).map(({index,width})=>{index&&(headerRef.current?.style.setProperty(`--th-${index}-width`,width+"px"),bodyRef.current?.style.setProperty(`--td-${index}-width`,width+"px"))}),bodyRef.current&&headerRef.current&&bodyRef.current.style.setProperty("--header-scroll-width",headerRef.current.scrollWidth+"px"))};e.useLayoutEffect(()=>{if(hiddenHeaderRef.current){const hiddenColumns=hiddenHeaderRef.current?.querySelectorAll(".th"),resizeObserver=new ResizeObserver(debounce(updateColumnsWidth,100));return hiddenColumns?.forEach(col=>resizeObserver.observe(col)),()=>{resizeObserver.disconnect()}}},[hiddenHeaderRef.current,headerRef.current,bodyRef.current,columnList,rowList]),e.useLayoutEffect(()=>{updateColumnsWidth()}),e.useLayoutEffect(()=>{const table=tableRef.current;if(table){const resizeObserver=new ResizeObserver(()=>{setTableHeight(table.getBoundingClientRect().height)});return resizeObserver.observe(table),()=>{resizeObserver.disconnect()}}},[setTableHeight]),e.useLayoutEffect(()=>{const header=headerRef.current;if(header){const resizeObserver=new ResizeObserver(()=>{setHeaderHeight(header.getBoundingClientRect().height)});return resizeObserver.observe(header),()=>{resizeObserver.disconnect()}}},[setHeaderHeight]),e.useLayoutEffect(()=>{const filler=fillerRef.current;if(filler){const resizeObserver=new ResizeObserver(()=>{filler.dataset.empty=String(0==filler.getBoundingClientRect().width)});return resizeObserver.observe(filler),()=>{resizeObserver.disconnect()}}},[]),e.useLayoutEffect(()=>{const table=tableRef.current,leftEdge=leftEdgeRef.current,enableShadow=stickyColumns.length>0||displayRowSelectionColumn||displayRowExpansionColumn||rowsDraggable;if(table&&leftEdge&&enableShadow){const observer=new IntersectionObserver(function([entry]){table&&(entry.isIntersecting&&entry.intersectionRatio>.99?table.setAttribute("data-shadow-left","false"):table.setAttribute("data-shadow-left","true"))},{root:table,threshold:[0,1]});return observer.observe(leftEdge),()=>observer.disconnect()}},[stickyColumns,displayRowExpansionColumn,displayRowSelectionColumn,rowsDraggable]),e.useLayoutEffect(()=>{const table=tableRef.current,rightEdge=rightEdgeRef.current;if(table&&rightEdge&&showRowsActions){const observer=new IntersectionObserver(function([entry]){table&&(entry.isIntersecting&&entry.intersectionRatio>.99?table.setAttribute("data-shadow-right","false"):table.setAttribute("data-shadow-right","true"))},{root:table,threshold:[0,1]});return observer.observe(rightEdge),()=>observer.disconnect()}},[showRowsActions]);function handleCheckboxChange(id){const groupInfo=groupToRowsMap[id],rowHasGroup=rowToGroupMap[id],groupCheckStatus=groupInfo&&(groupInfo=>{const indeterminate=groupInfo.rows.some(rowId=>rowToGroupMap[rowId]?.checked)&&groupInfo.rows.some(rowId=>!rowToGroupMap[rowId]?.checked);return{checked:groupInfo.rows.every(rowId=>rowToGroupMap[rowId]?.checked),indeterminate}})(groupInfo),parentGroupNewValue=rowHasGroup&&(changedDepId=>{const groupId=rowToGroupMap[changedDepId]?.groupId,groupInfo=groupId?groupToRowsMap[groupId]:void 0;if(!groupInfo)return;const value=groupInfo?.rows.some(rowId=>rowId===changedDepId.toString()?!rowToGroupMap[rowId]?.checked:rowToGroupMap[rowId]?.checked);return{groupId,value}})(id),idsMap=rowList.reduce((ids,row)=>{if(groupInfo){const rowInCurrentGroup=groupInfo.rows.includes(row.id.toString());row.id===id||rowInCurrentGroup?ids[row.id]=!(groupCheckStatus?.indeterminate||groupCheckStatus?.checked):ids[row.id]=row.id===id?!row.selected:!!row.selected}else ids[row.id]=row.id===id?!row.selected:!!row.selected,rowHasGroup&&row.id===parentGroupNewValue?.groupId&&(ids[row.id]=parentGroupNewValue?.value);return ids},{});onRowSelectionChange?.(idsMap,id)}function handleExpansionChange(id){const idsMap=rowList.reduce((ids,row)=>{const value=row.id===id?!row.expanded:!!row.expanded;return ids[row.id]=value,ids},{});onRowExpansionChange?.(idsMap)}const isSelected=row=>row.selected,allRowsChecked=rowList.length>0&&rowList.every(isSelected),someRowsChecked=rowList.some(isSelected);const handleResizeChange=e.useCallback(({name,width})=>{onColumnResize?.({name,width:width+"px"})},[onColumnResize]),handleSort=e.useCallback((name,colSort)=>{let newSort="initial";"asc"===colSort&&(newSort="desc"),"desc"===colSort&&(newSort="initial"),"initial"===colSort&&(newSort="asc"),onSortChange?.({name,sort:newSort})},[onSortChange]),multipleSort=e.useMemo(()=>columnList.filter(col=>!!col.sort).length>1,[columnList]),renderHeaderCell=(column,index,hidden)=>jsx(HeaderCellComponent,{column,index,columnsAmount:columnList.length,showDividerForLastColumn,disableColumnResize,headerLineClamp,headerExtraLineClamp,handleResizeChange,handleSort,dimension,spacingBetweenItems,multipleSort,columnMinWidth,hidden},`head_${column.name}`),renderBodyCell=idx=>(row,col)=>{const withResizer=col.name!==columnList[columnList.length-1].name||showDividerForLastColumn;return jsx(Cell,{$dimension:dimension,$resizer:withResizer,style:{width:`var(--td-${col.index}-width, 100px)`},className:"td","data-column":col.name,"data-row":row.id,children:col.renderCell?col.renderCell(row[col.name],row,idx):renderCell?renderCell(row,col.name):jsx(CellTextContent,{$cellAlign:col.cellAlign,children:row[col.name]})},`${row.id}_${col.name}`)},renderGroupRow=row=>{const indeterminate=row.groupRows?.some(rowId=>rowToGroupMap[rowId]?.checked)&&row.groupRows?.some(rowId=>!rowToGroupMap[rowId]?.checked),hasGroupRows=row.groupRows?.length,checked=hasGroupRows?row.groupRows?.every(rowId=>rowToGroupMap[rowId]?.checked):row.selected;return jsx(GroupRow,{row,dimension,checkboxDimension,displayRowExpansionColumn,displayRowSelectionColumn,rowsDraggable,onRowExpansionChange:handleExpansionChange,onRowSelectionChange:handleCheckboxChange,renderCell,indeterminate,checked})},renderRegularRow=(row,idx)=>jsx(RegularRow,{row,dimension,checkboxDimension,columns:columnList,stickyColumns,displayRowExpansionColumn,displayRowSelectionColumn,rowsDraggable,renderBodyCell:renderBodyCell(idx),onRowExpansionChange:handleExpansionChange,onRowSelectionChange:handleCheckboxChange}),renderRow=(row,index)=>{const isGroupRow=!!groupToRowsMap[row.id],visible=!!!rowToGroupMap[row.id]||groupToRowsMap[rowToGroupMap[row.id]?.groupId]?.expanded,isLastRow=(({row,isGroupRow,index,tableRows})=>isGroupRow?!row.expanded&&row.groupRows&&index>=tableRows.length-(row.groupRows.length+1):index===tableRows.length-1)({row,isGroupRow,tableRows,index}),rowWidth=isGroupRow?`var(--header-scroll-width, ${headerRef.current?.scrollWidth+"px"})`:void 0,node=(isGroupRow||visible)&&jsx(RowWrapper,{dimension,row,underline:isLastRow&&showLastRowUnderline&&!showBorders||!isLastRow,isGroup:isGroupRow,groupId:rowToGroupMap[row.id]?.groupId??null,onRowClick,onRowDoubleClick,rowWidth,grey:zebraRows[row.id]?.includes("even"),showRowsActions,rowStatusMap,tableRef,headerHeight,children:isGroupRow?renderGroupRow(row):renderRegularRow(row,index)},`row_${row.id}`);return node?renderRowWrapper?.(row,index,node)??node:node},renderEmptyMessage=()=>{const emptyMessage=locale?.emptyMessage||theme.locales[theme.currentLocale].table.emptyMessage;return jsx(Row,{$underline:showLastRowUnderline,$dimension:dimension,className:"tr",$rowWidth:`var(--header-scroll-width, ${headerRef.current?.scrollWidth+"px"})`,children:jsx(EmptyMessage,{$dimension:dimension,children:emptyMessage})})};return jsxs(TableContainer,{ref:refSetter(ref,tableRef),"data-shadow-left":!1,"data-shadow-right":!1,"data-borders":showBorders,"data-dragging":!1,...props,className:`table ${props.className||""}`,children:[jsxs(HiddenHeader,{ref:hiddenHeaderRef,$dimension:dimension,children:[(displayRowSelectionColumn||displayRowExpansionColumn||rowsDraggable||showRowsActions)&&jsxs(StickyWrapper,{children:[rowsDraggable&&jsx(DragCell,{$dimension:dimension}),displayRowExpansionColumn&&jsx(ExpandCell,{$dimension:dimension}),displayRowSelectionColumn&&jsx(CheckboxCell,{$dimension:dimension,children:jsx(CheckboxField,{dimension:checkboxDimension})}),showRowsActions&&jsx(ActionMock,{$dimension:dimension})]}),jsxs(HeaderCellsWrapper,{$expansionColumn:displayRowExpansionColumn,$selectionColumn:displayRowSelectionColumn,$overflowMenuColumn:showRowsActions,$dimension:dimension,children:[stickyColumns.length>0&&stickyColumns.map((col,index)=>renderHeaderCell(col,index,!0)),columnList.map((col,index)=>col.sticky?null:renderHeaderCell(col,index,!0))]})]}),jsx(HeaderWrapper,{className:"thead",children:jsxs(Header,{$dimension:dimension,$greyHeader:greyHeader,ref:headerRef,className:"tr",children:[(displayRowSelectionColumn||displayRowExpansionColumn||stickyColumns.length>0||rowsDraggable)&&jsxs(Fragment,{children:[jsx(Edge,{ref:leftEdgeRef}),jsxs(StickyWrapper,{ref:stickyColumnsWrapperRef,$greyHeader:greyHeader,children:[rowsDraggable&&jsx(DragCell,{$dimension:dimension,"data-draggable":!1,"data-droppable":!1}),displayRowExpansionColumn&&jsx(ExpandCell,{$dimension:dimension,"data-draggable":!1,"data-droppable":!1}),displayRowSelectionColumn&&jsx(CheckboxCell,{$dimension:dimension,className:"th_checkbox","data-th-column":"checkbox","data-draggable":!1,"data-droppable":!1,children:jsx(CheckboxField,{dimension:checkboxDimension,checked:allRowsChecked||someRowsChecked||headerCheckboxChecked,indeterminate:someRowsChecked&&!allRowsChecked||headerCheckboxIndeterminate,disabled:0===tableRows.length||headerCheckboxDisabled,onChange:function(e){const toRemove=rowList.reduce((ids,row)=>(ids[row.id]=row.checkboxDisabled?!!row.selected:!someRowsChecked,ids),{});onRowSelectionChange?.(toRemove),onHeaderSelectionChange?.(e.target.checked)}})}),stickyColumns.length>0&&stickyColumns.map((col,index)=>renderHeaderCell(col,index))]})]}),jsx(NormalWrapper,{ref:normalColumnsWrapperRef,children:columnList.map((col,index)=>col.sticky?null:renderHeaderCell(col,index))}),jsx(Filler,{ref:fillerRef}),showRowsActions&&jsxs(Fragment,{children:[jsx(ActionMock,{$dimension:dimension}),jsx(Edge,{ref:rightEdgeRef})]})]})}),virtualScroll&&(virtualScroll.fixedRowHeight||virtualScroll.estimatedRowHeight)?virtualScroll.fixedRowHeight?jsx(FixedSizeBody,{rowList:tableRows,childHeight:virtualScroll.fixedRowHeight,renderRow,renderEmptyMessage:tableRows.length?void 0:renderEmptyMessage,ref:bodyRef,className:"tbody",tableRef,tableHeight,headerHeight}):jsx(DynamicSizeBody,{tableRef,tableHeight,headerHeight,rowList:tableRows,renderRow,renderEmptyMessage:tableRows.length?void 0:renderEmptyMessage,estimatedRowHeight:virtualScroll.estimatedRowHeight,ref:bodyRef,className:"tbody"}):jsx(Body,{ref:bodyRef,className:"tbody",children:tableRows.length?tableRows.map((row,index)=>renderRow(row,index)):renderEmptyMessage()}),jsx(ColumnDrag,{onColumnDrag,onColumnDragEnd,dimension,isAnyColumnDraggable,isAnyStickyColumnDraggable,tableRef,normalColumnsWrapperRef,stickyColumnsWrapperRef,draggedColumnCssMixin}),jsx(RowDrag,{onRowDrag,onRowDragEnd,dimension,rowsDraggable,tableRef,bodyRef,rowToGroupMap,draggedRowCssMixin})]})});Table.displayName="Table";export{DEFAULT_COLUMN_WIDTH,Table};
//# sourceMappingURL=index.es.js.map
