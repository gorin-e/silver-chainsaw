"use strict";var jsxRuntime=require("react/jsx-runtime"),styled=require("styled-components"),changeInputData=require("../../common/dom/changeInputData.cjs.js"),refSetter=require("../../common/utils/refSetter.cjs.js"),index$1=require("../TextInput/index.cjs.js"),SmallArrowDownOutline=require("../../../node_modules/@admiral-ds/icons/build/system/SmallArrowDownOutline.svg.cjs.js"),constants=require("./constants.cjs.js"),Flag=require("./Flag.cjs.js"),defaultPhoneNumberInputHandle=require("./defaultPhoneNumberInputHandle.cjs.js"),CountriesList=require("./CountriesList.cjs.js"),uid=require("../../common/uid.cjs.js"),findCoutryWithPriority=require("./findCoutryWithPriority.cjs.js"),index_es=require("../../../node_modules/@admiral-ds/flags/dist/index.es.cjs.js"),index=require("../../DropdownContainer/index.cjs.js"),keyboardKey=require("../../common/keyboardKey.cjs.js"),GlobeOutline=require("../../../node_modules/@admiral-ds/icons/build/category/GlobeOutline.svg.cjs.js"),e=require("react");function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var styled__default=_interopDefault(styled);const Chevron=styled__default.default(SmallArrowDownOutline.ReactComponent)`
  transition: transform 0.3s;
  flex-shrink: 0;
  margin-left: 1px;

  & path {
    fill: ${p=>p.disabled?`var(--admiral-color-Neutral_Neutral30, ${p.theme.color["Neutral/Neutral 30"]})`:`var(--admiral-color-Neutral_Neutral50, ${p.theme.color["Neutral/Neutral 50"]})`};
  }
  ${p=>p.disabled&&"pointer-events: none;"}
`,disabledStyles=styled.css`
  & svg {
    opacity: 0.4;
  }
`,PhoneContainer=styled__default.default.div`
  position: relative;

  & ${Chevron} {
    width: ${p=>"s"===p.$dimension?"20px":"24px"};
    height: ${p=>"s"===p.$dimension?"20px":"24px"};
  }

  & input {
    padding-left: ${p=>"s"===p.$dimension?p.readOnly?"40px":"60px":p.readOnly?"48px":"72px"};
  }
`,CountryContainer=styled__default.default.div`
  cursor: ${({disabled,$isLoading})=>disabled?"not-allowed":$isLoading?"default":"pointer"};
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  display: flex;
  height: ${p=>"s"===p.$dimension?"20px":"24px"};

  & ${Chevron} {
    & *[fill^='#'] {
      stroke: none;
    }

    transform: ${p=>p.$isOpened&&!p.disabled?"rotate(180deg)":"rotate(0deg)"};
  }

  ${p=>p.disabled&&disabledStyles};
  visibility: ${p=>p.$skeleton?"hidden":"visible"};
`,PhoneInputDropContainer=styled__default.default(index.StyledDropdownContainer)`
  width: 100%;
`,FlagContainer=styled__default.default.div`
  line-height: initial;
  width: ${p=>"s"===p.$dimension?"18":"22"}px;
`,AVAILABLE_ALPHA3_CODES=Object.keys(index_es.ComponentsNames),PhoneNumberInput=e.forwardRef(({value="",disabled=!1,dimension="xl",defaultCountry="RUS",onlyCountries=AVAILABLE_ALPHA3_CODES,handleInput,skeleton=!1,dropContainerCssMixin,dropContainerClassName,dropContainerStyle,...props},ref)=>{const[activeIndex,setActiveIndex]=e.useState(-1),[selectedIndex,setSelectedIndex]=e.useState(-1),inputContainerRef=e.useRef(null),inputRef=e.useRef(null),containerRef=e.useRef(null),[isOpened,setIsOpened]=e.useState(!1),menuDimension=e.useMemo(()=>"xl"===dimension?"l":dimension,[dimension]),countryList=e.useMemo(()=>onlyCountries.reduce((acc,iso3)=>{const codes=constants.CountryCodes[iso3];return codes&&codes.forEach(code=>acc.push({iso3,code})),acc},[]).map(item=>{const{iso3,code}=item;return{...item,rusName:index_es.CountriesRusNames[iso3],name:index_es.ComponentsNames[iso3],uid:uid.uid(),handleInput:handleInput||defaultPhoneNumberInputHandle.clojureHandler(code)}}).sort((a,b)=>a.rusName.localeCompare(b.rusName,"ru")),[onlyCountries]),getNeedShowPlaceholder=countryIndex=>{const trimmedValue=value.trim();return!!props.placeholder&&countryIndex>-1&&("+"===trimmedValue||!!selectedIndex&&trimmedValue===countryList[countryIndex].code)},[showPlaceholder,setShowPlaceholder]=e.useState(getNeedShowPlaceholder(selectedIndex)),findCountry=e.useMemo(()=>findCoutryWithPriority(countryList),[countryList]),currentCountry=e.useMemo(()=>findCountry(value),[value]),currentCountryIndex=currentCountry?countryList.findIndex(item=>item.iso3===currentCountry.iso3&&item.code===currentCountry.code):-1,selectedCountryCode=selectedIndex>-1?countryList[selectedIndex].code:null;currentCountryIndex===selectedIndex||currentCountry?.code===selectedCountryCode||(setSelectedIndex(currentCountryIndex),setShowPlaceholder(getNeedShowPlaceholder(currentCountryIndex)));const handleInputRef=currentCountryIndex>-1?countryList[currentCountryIndex].handleInput:defaultPhoneNumberInputHandle.defaultPhoneNumberInputHandler;e.useEffect(()=>{if(defaultCountry&&-1===selectedIndex){const index=countryList.findIndex(country=>country.iso3===defaultCountry);index>-1&&selectCountry(index)}},[defaultCountry]);const selectCountry=indexNumber=>{if(!inputRef.current||indexNumber===selectedIndex)return;const hasOldSelected=selectedIndex>-1,oldCode=hasOldSelected?countryList[selectedIndex].code.replace(/[^0-9+]/g,""):"",newCode=countryList[indexNumber].code.replace(/[^0-9+]/g,""),oldCodeLength=oldCode.length,newCodeLength=newCode.length,selStart=(inputRef.current?.selectionStart||0)+(newCodeLength-oldCodeLength),selEnd=(inputRef.current?.selectionEnd||0)+(newCodeLength-oldCodeLength);changeInputData.changeInputData(inputRef.current,{value:hasOldSelected?value.replace(/\s+/g,"").replace(oldCode,newCode):newCode+value.replace(/\s+/g,""),selectionStart:selStart>0?selStart:1,selectionEnd:selEnd>0?selEnd:1}),setSelectedIndex(indexNumber),setIsOpened(!1)},IconComponent=e.useMemo(()=>{const SvgComponent=selectedIndex>-1?index_es.FlagsPack[countryList[selectedIndex].name]:GlobeOutline.ReactComponent;return jsxRuntime.jsx(Flag.Flag,{dimension:menuDimension,Component:SvgComponent})},[selectedIndex]);e.useEffect(()=>{setActiveIndex(isOpened?selectedIndex:-1)},[isOpened]),e.useEffect(()=>{isOpened&&setActiveIndex(selectedIndex)},[selectedIndex]);return jsxRuntime.jsxs(PhoneContainer,{ref:containerRef,$dimension:dimension,disabled,readOnly:props.readOnly,children:[jsxRuntime.jsx(index$1.TextInput,{...props,type:"tel",ref:refSetter.refSetter(ref,inputRef),handleInput:showPlaceholder?void 0:handleInputRef,containerRef:inputContainerRef,value:showPlaceholder?"":value,placeholder:showPlaceholder?props.placeholder:void 0,disabled,dimension,skeleton,displayClearIcon:!1,onKeyDown:(...p)=>{props.onKeyDown?.(...p),(e=>{switch(keyboardKey.keyboardKey.getCode(e)){case keyboardKey.keyboardKey[" "]:case keyboardKey.keyboardKey.Enter:isOpened&&(e.preventDefault(),selectedIndex!==activeIndex&&selectCountry(activeIndex));break;case keyboardKey.keyboardKey.ArrowDown:case keyboardKey.keyboardKey.ArrowUp:isOpened||(setIsOpened(!0),e.preventDefault(),e.stopPropagation());break;case keyboardKey.keyboardKey.Escape:isOpened&&(setIsOpened(!1),e.preventDefault())}})(...p)},onBlur:e=>{const trimmedValue=value.trim();props.placeholder&&("+"===trimmedValue||selectedIndex&&trimmedValue===countryList[selectedIndex].code)&&setShowPlaceholder(!0),props.onBlur?.(e)},onFocus:e=>{setShowPlaceholder(!1),props.onFocus?.(e)},children:isOpened&&!disabled&&!skeleton&&jsxRuntime.jsx(PhoneInputDropContainer,{targetElement:inputRef.current,onClickOutside:e=>{e.target&&containerRef.current?.contains(e.target)||setIsOpened(!1)},alignSelf:"stretch",dropContainerCssMixin,className:dropContainerClassName,style:dropContainerStyle,children:jsxRuntime.jsx(CountriesList.CountriesList,{countries:countryList,selected:selectedIndex>-1?countryList[selectedIndex].uid:void 0,active:activeIndex>-1?countryList[activeIndex].uid:void 0,onActivateItem:id=>{const index=countryList.findIndex(item=>item.uid===id);setActiveIndex(index)},onSelectItem:id=>{const index=countryList.findIndex(item=>item.uid===id);selectCountry(index)},dimension:menuDimension})})}),jsxRuntime.jsxs(CountryContainer,{$skeleton:skeleton,$dimension:dimension,$isOpened:isOpened,disabled,$isLoading:props.isLoading,onClick:props.isLoading?void 0:()=>{setIsOpened(prev=>!prev)},children:[jsxRuntime.jsx(FlagContainer,{$dimension:dimension,children:IconComponent}),!props.readOnly&&jsxRuntime.jsx(Chevron,{disabled})]})]})});PhoneNumberInput.displayName="PhoneNumberInput",exports.PhoneNumberInput=PhoneNumberInput;
//# sourceMappingURL=index.cjs.js.map
