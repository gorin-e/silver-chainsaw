import{jsx,jsxs}from"react/jsx-runtime";import styled,{css}from"styled-components";import{changeInputData}from"../../common/dom/changeInputData.es.js";import{refSetter}from"../../common/utils/refSetter.es.js";import{TextInput}from"../TextInput/index.es.js";import{ReactComponent as SvgSmallArrowDownOutline}from"../../../node_modules/@admiral-ds/icons/build/system/SmallArrowDownOutline.svg.es.js";import{CountryCodes}from"./constants.es.js";import{Flag}from"./Flag.es.js";import{clojureHandler,defaultPhoneNumberInputHandler}from"./defaultPhoneNumberInputHandle.es.js";import{CountriesList}from"./CountriesList.es.js";import{uid}from"../../common/uid.es.js";import getFindCountryFunction from"./findCoutryWithPriority.es.js";import{ComponentsNames as xp,CountriesRusNames as yp,FlagsPack as wp}from"../../../node_modules/@admiral-ds/flags/dist/index.es.es.js";import{StyledDropdownContainer}from"../../DropdownContainer/index.es.js";import{keyboardKey}from"../../common/keyboardKey.es.js";import{ReactComponent as SvgGlobeOutline}from"../../../node_modules/@admiral-ds/icons/build/category/GlobeOutline.svg.es.js";import{forwardRef,useState,useRef,useMemo,useEffect}from"react";const Chevron=styled(SvgSmallArrowDownOutline)`
  transition: transform 0.3s;
  flex-shrink: 0;
  margin-left: 1px;

  & path {
    fill: ${p=>p.disabled?`var(--admiral-color-Neutral_Neutral30, ${p.theme.color["Neutral/Neutral 30"]})`:`var(--admiral-color-Neutral_Neutral50, ${p.theme.color["Neutral/Neutral 50"]})`};
  }
  ${p=>p.disabled&&"pointer-events: none;"}
`,disabledStyles=css`
  & svg {
    opacity: 0.4;
  }
`,PhoneContainer=styled.div`
  position: relative;

  & ${Chevron} {
    width: ${p=>"s"===p.$dimension?"20px":"24px"};
    height: ${p=>"s"===p.$dimension?"20px":"24px"};
  }

  & input {
    padding-left: ${p=>"s"===p.$dimension?p.readOnly?"40px":"60px":p.readOnly?"48px":"72px"};
  }
`,CountryContainer=styled.div`
  cursor: ${({disabled,$isLoading})=>disabled?"not-allowed":$isLoading?"default":"pointer"};
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  display: flex;
  height: ${p=>"s"===p.$dimension?"20px":"24px"};

  & ${Chevron} {
    & *[fill^='#'] {
      stroke: none;
    }

    transform: ${p=>p.$isOpened&&!p.disabled?"rotate(180deg)":"rotate(0deg)"};
  }

  ${p=>p.disabled&&disabledStyles};
  visibility: ${p=>p.$skeleton?"hidden":"visible"};
`,PhoneInputDropContainer=styled(StyledDropdownContainer)`
  width: 100%;
`,FlagContainer=styled.div`
  line-height: initial;
  width: ${p=>"s"===p.$dimension?"18":"22"}px;
`,AVAILABLE_ALPHA3_CODES=Object.keys(xp),PhoneNumberInput=forwardRef(({value="",disabled=!1,dimension="xl",defaultCountry="RUS",onlyCountries=AVAILABLE_ALPHA3_CODES,handleInput,skeleton=!1,dropContainerCssMixin,dropContainerClassName,dropContainerStyle,...props},ref)=>{const[activeIndex,setActiveIndex]=useState(-1),[selectedIndex,setSelectedIndex]=useState(-1),inputContainerRef=useRef(null),inputRef=useRef(null),containerRef=useRef(null),[isOpened,setIsOpened]=useState(!1),menuDimension=useMemo(()=>"xl"===dimension?"l":dimension,[dimension]),countryList=useMemo(()=>onlyCountries.reduce((acc,iso3)=>{const codes=CountryCodes[iso3];return codes&&codes.forEach(code=>acc.push({iso3,code})),acc},[]).map(item=>{const{iso3,code}=item;return{...item,rusName:yp[iso3],name:xp[iso3],uid:uid(),handleInput:handleInput||clojureHandler(code)}}).sort((a,b)=>a.rusName.localeCompare(b.rusName,"ru")),[onlyCountries]),getNeedShowPlaceholder=countryIndex=>{const trimmedValue=value.trim();return!!props.placeholder&&countryIndex>-1&&("+"===trimmedValue||!!selectedIndex&&trimmedValue===countryList[countryIndex].code)},[showPlaceholder,setShowPlaceholder]=useState(getNeedShowPlaceholder(selectedIndex)),findCountry=useMemo(()=>getFindCountryFunction(countryList),[countryList]),currentCountry=useMemo(()=>findCountry(value),[value]),currentCountryIndex=currentCountry?countryList.findIndex(item=>item.iso3===currentCountry.iso3&&item.code===currentCountry.code):-1,selectedCountryCode=selectedIndex>-1?countryList[selectedIndex].code:null;currentCountryIndex===selectedIndex||currentCountry?.code===selectedCountryCode||(setSelectedIndex(currentCountryIndex),setShowPlaceholder(getNeedShowPlaceholder(currentCountryIndex)));const handleInputRef=currentCountryIndex>-1?countryList[currentCountryIndex].handleInput:defaultPhoneNumberInputHandler;useEffect(()=>{if(defaultCountry&&-1===selectedIndex){const index=countryList.findIndex(country=>country.iso3===defaultCountry);index>-1&&selectCountry(index)}},[defaultCountry]);const selectCountry=indexNumber=>{if(!inputRef.current||indexNumber===selectedIndex)return;const hasOldSelected=selectedIndex>-1,oldCode=hasOldSelected?countryList[selectedIndex].code.replace(/[^0-9+]/g,""):"",newCode=countryList[indexNumber].code.replace(/[^0-9+]/g,""),oldCodeLength=oldCode.length,newCodeLength=newCode.length,selStart=(inputRef.current?.selectionStart||0)+(newCodeLength-oldCodeLength),selEnd=(inputRef.current?.selectionEnd||0)+(newCodeLength-oldCodeLength);changeInputData(inputRef.current,{value:hasOldSelected?value.replace(/\s+/g,"").replace(oldCode,newCode):newCode+value.replace(/\s+/g,""),selectionStart:selStart>0?selStart:1,selectionEnd:selEnd>0?selEnd:1}),setSelectedIndex(indexNumber),setIsOpened(!1)},IconComponent=useMemo(()=>{const SvgComponent=selectedIndex>-1?wp[countryList[selectedIndex].name]:SvgGlobeOutline;return jsx(Flag,{dimension:menuDimension,Component:SvgComponent})},[selectedIndex]);useEffect(()=>{setActiveIndex(isOpened?selectedIndex:-1)},[isOpened]),useEffect(()=>{isOpened&&setActiveIndex(selectedIndex)},[selectedIndex]);return jsxs(PhoneContainer,{ref:containerRef,$dimension:dimension,disabled,readOnly:props.readOnly,children:[jsx(TextInput,{...props,type:"tel",ref:refSetter(ref,inputRef),handleInput:showPlaceholder?void 0:handleInputRef,containerRef:inputContainerRef,value:showPlaceholder?"":value,placeholder:showPlaceholder?props.placeholder:void 0,disabled,dimension,skeleton,displayClearIcon:!1,onKeyDown:(...p)=>{props.onKeyDown?.(...p),(e=>{switch(keyboardKey.getCode(e)){case keyboardKey[" "]:case keyboardKey.Enter:isOpened&&(e.preventDefault(),selectedIndex!==activeIndex&&selectCountry(activeIndex));break;case keyboardKey.ArrowDown:case keyboardKey.ArrowUp:isOpened||(setIsOpened(!0),e.preventDefault(),e.stopPropagation());break;case keyboardKey.Escape:isOpened&&(setIsOpened(!1),e.preventDefault())}})(...p)},onBlur:e=>{const trimmedValue=value.trim();props.placeholder&&("+"===trimmedValue||selectedIndex&&trimmedValue===countryList[selectedIndex].code)&&setShowPlaceholder(!0),props.onBlur?.(e)},onFocus:e=>{setShowPlaceholder(!1),props.onFocus?.(e)},children:isOpened&&!disabled&&!skeleton&&jsx(PhoneInputDropContainer,{targetElement:inputRef.current,onClickOutside:e=>{e.target&&containerRef.current?.contains(e.target)||setIsOpened(!1)},alignSelf:"stretch",dropContainerCssMixin,className:dropContainerClassName,style:dropContainerStyle,children:jsx(CountriesList,{countries:countryList,selected:selectedIndex>-1?countryList[selectedIndex].uid:void 0,active:activeIndex>-1?countryList[activeIndex].uid:void 0,onActivateItem:id=>{const index=countryList.findIndex(item=>item.uid===id);setActiveIndex(index)},onSelectItem:id=>{const index=countryList.findIndex(item=>item.uid===id);selectCountry(index)},dimension:menuDimension})})}),jsxs(CountryContainer,{$skeleton:skeleton,$dimension:dimension,$isOpened:isOpened,disabled,$isLoading:props.isLoading,onClick:props.isLoading?void 0:()=>{setIsOpened(prev=>!prev)},children:[jsx(FlagContainer,{$dimension:dimension,children:IconComponent}),!props.readOnly&&jsx(Chevron,{disabled})]})]})});PhoneNumberInput.displayName="PhoneNumberInput";export{PhoneNumberInput};
//# sourceMappingURL=index.es.js.map
